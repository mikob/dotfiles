# timing, ~0.35s

# Source Prezto.
source "${HOME}/.zgen/zgen.zsh"

export KEYTIMEOUT=1       # elimate delay with switching to vi mode
# RVM seems to be loaded quickly, so we don't need to lazy load
export PATH=$PATH:$HOME/.rvm/bin # Add RVM to PATH for scripting
export PATH=$PATH:$HOME/.zgen/jimeh/tmuxifier-master/bin
export PATH=/usr/bin:$PATH     # hack to give /usr/bin priority
export PATH="$HOME/tools/google_appengine/":$PATH
export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64
export EDITOR=nvim
export INPUTRC=$HOME/.inputrc
export DEV_ENV=1
export NODE_ENV=development
export LC_ALL=en_US.UTF-8
export TMUXIFIER=$HOME/.zgen/jimeh/tmuxifier-master
export FZF_DEFAULT_COMMAND='ag -g "" -U'


# IMPORTANT:
# Need to edit zgen save file manually anytime it's changed to make sure autoenv loads after python in order for
# .autoenv.zsh to work properly with workon command
if ! zgen saved; then
zgen prezto prompt theme 'miko'
zstyle ':prezto:*:*' color 'yes'

zgen prezto
zgen prezto git
zgen prezto completion
zgen prezto python
zgen prezto command-not-found
#zgen prezto syntax-highlighting
zgen prezto ssh
zgen prezto tmux
# zgen prezto autosuggestions
# zgen prezto history-substring-search # causes issues with ctrl-y

# these two have prezto modules but the autosuggestions are white (instead of grey)
# when using the prezto versions
zgen load zsh-users/zsh-syntax-highlighting
zgen load zsh-users/zsh-autosuggestions

zgen load Tarrasch/zsh-autoenv
zgen load lukechilds/zsh-nvm
zgen load jimeh/tmuxifier
zgen load junegunn/fzf shell
# adds 0.3s to startup
zgen load felixr/docker-zsh-completion

zgen save
fi

setopt vi 	 	  # edit command in vi mode
setopt auto_cd  	  # no need to type cd, just type the command name
setopt clobber  	  # zsh disable certain redirection warnings
setopt auto_pushd
setopt correct
unsetopt histverify

autoload -U zmv    	  # fancy file mover with substitutions

bindkey '^u' backward-kill-line
bindkey '^r' history-incremental-search-backward
bindkey '^p' fzf-file-widget
bindkey '^l' autosuggest-execute
bindkey '^e' end-of-line

# only the first of each command has an alias searched for. So
# make the last character a space, so the next word following the alias
# is also checked for expansion
alias sudo='sudo '
alias rm="trash-put"
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias vim='nvr'
# Add an "alert" alias for long running commands.  Use like so:
#   sleep 10; alert
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'
alias opn="xdg-open `pwd`"
alias fnd="find ./ -iname $@"
alias ls="ls -h --color=auto"
alias info="info --vi-keys"
alias dkrm="docker ps -aqf 'status=exited' | xargs -L 1 docker rm -f"
alias dkrmi="docker images -f 'dangling=true' -q | xargs docker rmi"
alias cp='cp -i'
alias mv='mv -i'
alias make='make -j4'
alias grep='grep -i'
alias rsync='rsync -zav'
alias dl='docker logs -f --tail 1000'
alias rbd="echo \"keys $@\" | xargs redis-cli | cut --delimiter ' ' -f 1 | xargs redis-cli DEL"
# Fix cinnamon when it get's f'd up
alias cinn_restart='pkill -HUP -f "cinnamon --replace"'

# Miko's custom shell functions
function cds() { cd "$@" && ls; }

function swp() { mv "$1" "$1.swap" && mv "$2" "$1" && mv "$1.swap" "$2" }

function rmhist() {
    args="$@"
    if [ "${#args}" -gt 2 ]
    then
	grep -v "$@" ~/.zhistory > ~/.zhistory_backup && swp ~/.zhistory ~/.zhistory_backup
    else
	echo "argument should be at least 3 characters"
    fi
}

function dksr() { docker stop "$1" && docker rm "$1"; }

function unz() { unzip "$@" && rm "$@"; }

# custom open search results in vim
function agvim() {
    ag "$@" && read;
    vim "-c bufdo /$@" $(ag -l $@);
}

vicd()
{
    local dst="$(command vifm --choose-dir -)"
    if [ -z "$dst" ]; then
	    echo 'Directory picking cancelled/failed'
	    return 1
    fi
    cd "$dst"
}

unset_docker()
{
    unset DOCKER_TLS_VERIFY
    unset DOCKER_HOST
    unset DOCKER_CERT_PATH
    unset DOCKER_API_VERSION
}

[ -f "$HOME/.zshrc-custom" ] && source "$HOME/.zshrc-custom"
[ -s $HOME/.rvm/scripts/rvm ] && . "$HOME/.rvm/scripts/rvm"
#source <(kubectl completion zsh)     # kubernetes auto-completion is slow (0.3s)
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# hack to get things running after zshrc is loaded in gnome-terminal
# eg. gnome-terminal -x sh -c 'export POST_RC="echo hi"; exec zsh'
eval "$POST_RC"
